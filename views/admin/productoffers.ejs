<%- include('header') %>
<nav class="navbar navbar-expand-lg navbar-dark shadow-sm">
  <div class="container">
    <a href="#" class="navbar-brand">Admin Dashboard</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav mx-auto">
        <li class="nav-item"><a href="/admin/dashboard" class="nav-link">Dashboard</a></li>
        <li class="nav-item"><a href="/admin/users" class="nav-link">Users</a></li>
        <li class="nav-item"><a href="/admin/categories" class="nav-link">Categories</a></li>
        <li class="nav-item"><a href="/admin/product" class="nav-link">Products</a></li>
        <li class="nav-item"><a href="/admin/orders" class="nav-link">Orders</a></li>
        <li class="nav-item"><a href="/admin/coupons" class="nav-link">Coupons</a></li>
        <li class="nav-item"><a href="/admin/productoffers" class="nav-link">Product Offer</a></li>
        <li class="nav-item"><a href="/admin/categoryoffers" class="nav-link">Category Offer</a></li>
      </ul>
      <a href="/admin/logout" class="btn btn-outline-danger fw-bold">Logout</a>
    </div>
  </div>
</nav>
    <!-- Add Product Offer Button -->
<div class="d-flex justify-content-between align-items-center mb-3 p-3">
    <h3 class="fw-bold">Product Offer Management</h3>
    <button class="btn btn-custom" data-bs-toggle="modal" data-bs-target="#addProductOfferModal">
        <i class="fas fa-plus"></i> Add Product Offer
    </button>
</div>
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>S. No.</th>
                <th>Product Name</th>
                <th>Percentage</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Status</th>
                <th>Edit</th>
            </tr>
        </thead>
        <tbody>
            <% offers.forEach((offer, index) => { %>
                <tr>
                    <td><%= index + 1 %></td>
                    <td><%= offer.product.name %></td>
                    <td><%= offer.percentage %>%</td>
                    <td><%= offer.startDate.toDateString() %></td>
                    <td><%= offer.endDate.toDateString() %></td>
                    <td>
                        <span class="<%= offer.status === 'Active' ? 'status-active' : 'status-inactive' %>">
                            <%= offer.status %>
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-warning btn-sm editOfferBtn"
                            data-id="<%= offer._id %>"
                            data-product="<%= offer.product._id %>"
                            data-percentage="<%= offer.percentage %>"
                            data-startdate="<%= offer.startDate.toISOString().split('T')[0] %>"
                            data-enddate="<%= offer.endDate.toISOString().split('T')[0] %>"
                            data-status="<%= offer.status %>">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </td>
                </tr>
            <% }); %>
        </tbody>
    </table>
    <!-- Add Product Offer Modal -->
<div class="modal fade" id="addProductOfferModal" tabindex="-1" aria-labelledby="addProductOfferModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addProductOfferModalLabel">Add Product Offer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addProductOfferForm">
                    <div class="mb-3">
                        <label for="productSelect" class="form-label">Product</label>
                        <select id="productSelect" class="form-select" name="product" required>
                            <option value="">Select a Product</option>
                            <% products.forEach(product => { %>
                                <option value="<%= product._id %>"><%= product.name %></option>
                            <% }); %>
                        </select>                        
                    </div>
                    <div class="mb-3">
                        <label for="percentage" class="form-label">Percentage</label>
                        <input type="number" id="percentage" name="percentage" class="form-control" min="1" max="100" required>
                    </div>
                    <div class="mb-3">
                        <label for="startDate" class="form-label">Start Date</label>
                        <input type="date" id="startDate" name="startDate" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="endDate" class="form-label">End Date</label>
                        <input type="date" id="endDate" name="endDate" class="form-control" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveOffer">Save Changes</button>
            </div>
        </div>
    </div>
</div>
<!-- Edit Product Offer Modal -->
<div class="modal fade" id="editOfferModal" tabindex="-1" aria-labelledby="editOfferModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Product Offer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editOfferForm">
                    <input type="hidden" id="editOfferId">

                    <div class="mb-3">
                        <label for="editProductSelect" class="form-label">Product</label>
                        <select id="editProductSelect" class="form-control">
                            <% products.forEach(product => { %>
                                <option value="<%= product._id %>"><%= product.name %></option>
                            <% }) %>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="editPercentage" class="form-label">Discount Percentage</label>
                        <input type="number" id="editPercentage" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label for="editStartDate" class="form-label">Start Date</label>
                        <input type="date" id="editStartDate" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label for="editEndDate" class="form-label">End Date</label>
                        <input type="date" id="editEndDate" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label for="editStatus" class="form-label">Status</label>
                        <select id="editStatus" class="form-control">
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- JavaScript to Handle Submission -->
<script>
    document.addEventListener("DOMContentLoaded", () => {
    document.getElementById('saveOffer').addEventListener('click', async () => {
        const productId = document.getElementById('productSelect').value;
        const percentage = document.getElementById('percentage').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const status = "Active"; // Default status

        // Debugging: Log values before sending request
        console.log({ productId, percentage, startDate, endDate, status });

        const response = await fetch('/admin/add-product-offer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ product: productId, percentage, startDate, endDate, status })
        });

        if (response.ok) {
            location.reload();
        } else {
            alert('Failed to add product offer.');
        }
    });
});
</script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        // Handle Edit Button Click
        document.querySelectorAll(".editOfferBtn").forEach(button => {
            button.addEventListener("click", () => {
                // Get data from button
                const offerId = button.getAttribute("data-id");
                const productId = button.getAttribute("data-product");
                const percentage = button.getAttribute("data-percentage");
                const startDate = button.getAttribute("data-startdate");
                const endDate = button.getAttribute("data-enddate");
                const status = button.getAttribute("data-status");
    
                // Set values in modal form
                document.getElementById("editOfferId").value = offerId;
                document.getElementById("editProductSelect").value = productId;
                document.getElementById("editPercentage").value = percentage;
                document.getElementById("editStartDate").value = startDate;
                document.getElementById("editEndDate").value = endDate;
                document.getElementById("editStatus").value = status;
    
                // Show modal
                var editModal = new bootstrap.Modal(document.getElementById("editOfferModal"));
                editModal.show();
            });
        });
    
        // Handle Form Submission
        document.getElementById("editOfferForm").addEventListener("submit", async (e) => {
            e.preventDefault();
    
            const offerId = document.getElementById("editOfferId").value;
            const product = document.getElementById("editProductSelect").value;
            const percentage = document.getElementById("editPercentage").value;
            const startDate = document.getElementById("editStartDate").value;
            const endDate = document.getElementById("editEndDate").value;
            const status = document.getElementById("editStatus").value;
    
            // Send Update Request
            const response = await fetch(`/admin/edit-product-offer/${offerId}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ product, percentage, startDate, endDate, status })
            });
    
            if (response.ok) {
                location.reload();
            } else {
                alert("Failed to update product offer.");
            }
        });
    });
    </script>
    
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
