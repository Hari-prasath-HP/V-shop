<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Details</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/style.css"> <!-- Link to your CSS file -->
    <style>
      body {
          background-color: #f8f9fa;
          font-family: 'Arial', sans-serif;
      }

      .breadcrumb {
          background-color: #fff;
          border-radius: 8px;
          padding: 10px 15px;
          box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      .user-option .card-title {
          font-size: 16px;
          font-weight: bold;
      }
      .user-option {
          border: 1px solid #ddd;
          border-radius: 8px;
          background-color: #fff;
          box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
          transition: all 0.3s ease;
      }

      .user-option:hover {
          cursor: pointer;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
          transform: translateY(-5px);
      }

      .user-option .card-body {
          padding: 20px;
      }
      .order-info {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
      .user-option .card-title {
          font-size: 16px;
          font-weight: bold;
      }

      table {
          width: 100%;
          margin-top: 20px;
          border-collapse: collapse;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      th, td {
          padding: 12px;
          text-align: center;
          border: 1px solid #ddd;
      }

      th {
          background-color: #4f5254;
          color: white;
      }

      td {
          background-color: #fff;
      }

      tr:nth-child(even) td {
          background-color: #f2f2f2;
      }

      button {
          border: none;
          padding: 8px 16px;
          font-size: 14px;
          border-radius: 5px;
          cursor: pointer;
          transition: background-color 0.3s ease;
      }
      .product-img {
            width: 50px;
            height: 50px;
            object-fit: cover;
        }
        .btn-action {
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
        }
      button:hover {
          opacity: 0.8;
      }

      .btn-primary {
          background-color: #007bff;
          color: white;
      }

      .btn-danger {
          background-color: #dc3545;
          color: white;
      }

      .btn-success {
          background-color: #28a745;
          color: white;
      }

      .pagination {
          margin-top: 20px;
          text-align: center;
      }

      .pagination a {
          text-decoration: none;
          padding: 8px 12px;
          border-radius: 5px;
          margin: 0 5px;
          background-color: #f8f9fa;
          color: #007bff;
          transition: background-color 0.3s ease;
      }

      .pagination a:hover {
          background-color: #007bff;
          color: white;
      }

      .pagination span {
          font-size: 16px;
          margin: 0 10px;
      }

      .container {
          margin-top: 30px;
      }
      html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        /* Main content should take full height and push footer down */
        .main-content {
            flex: 1;
        }

        /* Footer styling */
        footer {
            background-color: #333;
            color: white;
            padding: 20px 0;
            text-align: center;
            position: relative;
            width: 100%;
        }
        footer .text-muted {
            color: #aaa;
        }

        footer .social-icons a {
            color: #fff;
            margin: 0 10px;
            font-size: 18px;
        }

        footer .social-icons a:hover {
            color: #ff6600;
        }
        .breadcrumb a {
            text-decoration: none;
            color: inherit;
        }

        .breadcrumb-item a {
            color: #6e7478; /* Set a neutral color similar to text */
            font-weight: normal;
        }
        .card-link {
            text-decoration: none; /* Remove the default underline */
            color: inherit; /* Inherit the text color from the parent */
        }
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); }
    .modal-content { background-color: white; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 30%; }
    .close { float: right; font-size: 28px; cursor: pointer; }
    /* Toast Notification */
    .toast {
    visibility: hidden;
    min-width: 250px;
    background-color: #d9534f; /* Default color for error */
    color: white;
    text-align: center;
    border-radius: 5px;
    padding: 12px;
    position: fixed;
    z-index: 1000;
    right: 20px;
    top: 20px;
    font-size: 16px;
    opacity: 0;
    transition: opacity 0.5s, top 0.5s;
}

.toast.show {
    visibility: visible;
    opacity: 1;
    top: 30px;
}
    .confirmation-popup {
        display: none; /* Initially hidden */
        position: fixed;
        top: 10%; /* Adjusts the popup to be near the top */
        left: 50%; /* Centers horizontally */
        transform: translate(-50%, 0); /* Ensures perfect centering */
        background: rgb(49, 224, 18); /* Green background */
        color: white; /* White text for contrast */
        padding: 15px 25px;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        font-size: 16px;
        font-weight: bold;
        text-align: center;
        min-width: 250px; /* Ensures a readable size */
    }
    .modal {
        display: none;  /* Hide initially */
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        justify-content: center;
        align-items: center;
        animation: fadeIn 0.3s ease-in-out;
    }

    /* Modal Content */
    .modal-content {
        background: #fff;
        padding: 20px;
        width: 350px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        text-align: center;
        position: relative;
        animation: slideUp 0.3s ease-in-out;
    }

    /* Close Button */
    .close {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 22px;
        cursor: pointer;
        color: #555;
        transition: color 0.3s ease-in-out;
    }
    .close:hover {
        color: #e74c3c;
    }

    /* Modal Text */
    .modal-text {
        font-size: 16px;
        color: #333;
        margin-bottom: 10px;
    }

    /* Textarea */
    textarea {
        width: 100%;
        height: 80px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        resize: none;
        outline: none;
        transition: border 0.3s ease-in-out;
    }
    textarea:focus {
        border-color: #3498db;
    }

    /* Submit Button */
    .btn-submit {
        margin-top: 15px;
        background-color: #3498db;
        color: #fff;
        border: none;
        padding: 10px 15px;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
        width: 100%;
        transition: background-color 0.3s ease-in-out;
    }
    .btn-submit:hover {
        background-color: #2980b9;
    }

    /* Animations */
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    </style>
</head>
<body>

    <nav aria-label="breadcrumb" class="mt-3">
        <ol class="breadcrumb container">
            <li class="breadcrumb-item"><a href="/">Home</a></li>
            <li class="breadcrumb-item active" aria-current="page">User Details</li>
        </ol>
    </nav>
<div class="main-content">
    <!-- User Options Grid -->
    <div class="container mt-2">
        <div class="row g-3">
            <div class="col-md-2">
                <a href="/userdetails" class="card-link">
                    <div class="card user-option">
                        <div class="card-body text-center">
                            <p class="card-title">My Account</p>
                        </div>
                    </div>
                </a>
            </div>
            <div class="col-md-2">
                <a href="/address" class="card-link">
                    <div class="card user-option">
                        <div class="card-body text-center">
                            <p class="card-title">My Address</p>
                        </div>
                    </div>
                </a>
            </div>
            <div class="col-md-2">
                <a href="/add-address" class="card-link">
                    <div class="card user-option">
                        <div class="card-body text-center">
                            <p class="card-title">Add Address</p>
                        </div>
                    </div>
                </a>
            </div>
            <div class="col-md-2">
                <a href="/wallet" class="card-link">
                    <div class="card user-option">
                        <div class="card-body text-center">
                            <p class="card-title">Wallet</p>
                        </div>
                    </div>
                </a>
            </div> 
            <div class="col-md-2">
                <a href="/wishlist" class="card-link">
                    <div class="card user-option">
                        <div class="card-body text-center">
                            <p class="card-title">Wish List</p>
                        </div>
                    </div>
                </a>
            </div> 
            <div class="col-md-2">
                <a href="/orders" class="card-link">
                    <div class="card user-option">
                        <div class="card-body text-center">
                            <p class="card-title">All Orders</p>
                        </div>
                    </div>
                </a>
            </div>
        </div>
    </div>

    <div class="container mt-4">
        <h2>Order Details</h2>
        <div class="order-info mb-4">
            <p><strong>Order ID:</strong> <%= orderId %></p>
            <p><strong>Shipping Address:</strong> 
                <%= shippingAddress.name %>, 
                <%= shippingAddress.phone %>,
                <%= shippingAddress.houseNo %>,
                <%= shippingAddress.area %>,
                <%= shippingAddress.city %>, 
                <%= shippingAddress.state %>, 
                <%= shippingAddress.pincode %>, 
            </p>
            <p><strong>Payment Method:</strong> <%= paymentMethod %></p>
            <p><strong>Order Status:</strong> <%= orderStatus %></p>
            <p><strong>Ordered At:</strong> <%= orderedAt %></p>
            <p><strong>Payment Status:</strong> <%= paymentStatus %></p>
            <p><strong>Grand Total:</strong>₹<%= grandTotal %></p>
        </div>
        <button class="btn btn-dark mb-4" onclick="downloadInvoice('<%= orderId %>')">Download Invoice</button>
        <h2>Products</h2>
        <table class="mb-5">
            <thead>
                <tr>
                    <th>Image</th>
                    <th>Product Name</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Subtotal</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <% products.forEach(product => { %>
                    <tr>
                        <td>
                            <img src="<%= product.image %>" class="product-img" alt="<%= product.name %>"
                              onerror="this.onerror=null;this.src='https://res.cloudinary.com/your-cloud-name/image/upload/v123456789/default-image.jpg';">
                          </td>                                                  
                        <td><%= product.name %></td>
                        <td>₹<%= product.price %></td>
                        <td><%= product.quantity %></td>
                        <td>₹<%= product.subtotal %></td>
                        <td><%= product.status %></td>
                        <td>
                            <% if (product.status === 'Ordered') { %>
                                <button class="btn-action btn-danger" onclick="showPopup('cancel', '<%= orderId %>', '<%= product.productId %>')">Cancel</button>
                            <% } %>
                            <% if (product.status === 'Delivered') { %>
                                <button class="btn-action btn-success" onclick="showPopup('return', '<%= orderId %>', '<%= product.productId %>')">Return</button>
                            <% } %>
                        </td>
                    </tr>
                <% }) %>
            </tbody>
        </table>    
    </div>
</div>

<!-- Popup Modal -->
<div id="popupModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closePopup()">&times;</span>
        <h3 id="popupTitle"></h3>
        <p class="modal-text">Enter reason:</p>
        <textarea id="reasonInput" placeholder="Enter reason here..." required></textarea>
        <button class="btn-submit" onclick="submitReason()">Submit</button>
    </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="toast"></div>

<!-- Confirmation Popup -->
<div id="confirmationPopup" class="confirmation-popup">
    <div class="popup-content">
        <p id="confirmationMessage"></p>
    </div>
</div>

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <p>&copy; 2025 Vegishop. All rights reserved.</p>
            </div>
            <div class="col-md-6 text-md-end">
                <a href="privacy.html" class="text-white mx-2">Privacy Policy</a>
                <a href="terms.html" class="text-white mx-2">Terms of Service</a>
            </div>
        </div>
    </div>
</footer>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function downloadInvoice(orderId) {
        window.location.href = `/download-invoice/${orderId}`;
    }
</script>
<script>
    let actionType, orderId, productId;

    function showPopup(type, order, product) {
    if (!type || !order || !product) return;  // Prevent execution if values are missing

    actionType = type;
    orderId = order;
    productId = product;

    document.getElementById("popupTitle").innerText =
        type === 'cancel' ? 'Cancel Product' : 'Return Product';

    document.getElementById("popupModal").style.display = "flex"; // Show the modal only when clicked
}


    function closePopup() {
        document.getElementById("popupModal").style.display = "none";
    }

    function showToast(message, isError = false) {
        const toast = document.getElementById("toast");
        const progress = document.createElement("div");
        progress.classList.add("toast-progress");

        toast.innerText = message;
        toast.style.backgroundColor = isError ? "#f8d7da" : "#d4edda"; 
        toast.style.color = isError ? "#721c24" : "#155724"; 

        toast.appendChild(progress); // Add progress bar to toast
        toast.classList.add("show");

        setTimeout(() => {
            progress.style.width = "0%"; // Shrink progress bar
        }, 100); // Small delay to start animation

        setTimeout(() => {
            toast.classList.remove("show");
            setTimeout(() => progress.remove(), 500); // Remove progress bar after hiding
        }, 3000);
    }


    function showConfirmationPopup(message) {
        console.log("Inside showConfirmationPopup with message:", message); // Debugging

        const popup = document.getElementById("confirmationPopup");
        if (!popup) {
            console.error("Popup element not found!");
            return;
        }
        document.getElementById("confirmationMessage").innerText = message;
        popup.style.display = "block";

        setTimeout(() => {
            console.log("Hiding Confirmation Popup"); // Debugging
            popup.style.display = "none";
        }, 4000);
    }

    function submitReason() {
    const reason = document.getElementById("reasonInput").value.trim();
    
    if (!reason) {
        showToast("Please provide a reason.", true);
        return;
    }

    fetch(`/product/${actionType}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ orderId, productId, reason })
    })
    .then(response => response.json().catch(() => ({ error: true, message: "Invalid JSON response" })))
    .then(data => {
        if (data.error) {
            showToast(data.message, true);
        } else {
            showConfirmationPopup(`Product ${actionType === 'cancel' ? 'canceled' : 'returned'} successfully.`);
            setTimeout(() => location.reload(), 4000);
        }
    })
    .catch(err => {
        showToast("Something went wrong. Try again later.", true);
    });
}
</script>
</body>
</html>
